rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // User root doc
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;

      // Prevent clients from marking username as immutable or changing it once immutable.
      // The server (Cloud Functions) can set `usernameSetByUser: true` and `hasUsernamePin: true`.
      allow update: if request.auth != null
        && request.auth.uid == userId

        // If the username has been locked, it cannot change.
        && (resource.data.usernameSetByUser == true
            ? request.resource.data.username == resource.data.username
            : true)

        // Clients cannot flip usernameSetByUser from non-true to true.
        && (resource.data.usernameSetByUser == true
            ? request.resource.data.usernameSetByUser == true
            : request.resource.data.usernameSetByUser != true)

        // Clients cannot flip hasUsernamePin from non-true to true.
        && (resource.data.hasUsernamePin == true
            ? request.resource.data.hasUsernamePin == true
            : request.resource.data.hasUsernamePin != true);
    }

    // Any subcollections under the user
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Feedback (write-only from client)
    match /feedback/{feedbackId} {
      allow create: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.type in ['bug', 'confusing', 'feature', 'pricing', 'other']
        && request.resource.data.summary is string
        && request.resource.data.summary.size() > 0
        && request.resource.data.summary.size() <= 140
        // keep payload bounded
        && (!('details' in request.resource.data) || request.resource.data.details == null || request.resource.data.details.size() <= 4000);

      allow read, update, delete: if false;
    }

    // Prevent username enumeration and protect PIN secrets.
    match /usernameIndex/{usernameKey} {
      allow read, write: if false;
    }

    match /userSecrets/{uid} {
      allow read, write: if false;
    }
  }
}
