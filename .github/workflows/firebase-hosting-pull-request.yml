# This file was auto-generated by the Firebase CLI and modified for dev env vars in PR previews

name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install React app dependencies
        run: npm install

      - name: Load Dev Environment Variables for Preview Build
        env:
          # Use DEV_ENV_VARS for PR previews, so the frontend build
          # points to your development Firebase project's API keys etc.
          JSON_SECRET_CONTENT: ${{ secrets.DEV_ENV_VARS }}
        run: |
          declare -A mapping=(
              ["FirebaseAPIKey"]="VITE_FIREBASE_API_KEY"
              ["FirebaseAuthDomain"]="VITE_FIREBASE_AUTH_DOMAIN"
              ["FirebaseProjectID"]="VITE_FIREBASE_PROJECT_ID"
              ["FirebaseMessagingSenderId"]="VITE_FIREBASE_MESSAGING_SENDER_ID"
              ["FirebaseAppId"]="VITE_FIREBASE_APP_ID"
              ["FirebaseStorageBucket"]="VITE_FIREBASE_STORAGE_BUCKET"
              ["FirebaseMeasurementId"]="VITE_FIREBASE_MEASUREMENT_ID"
          )

          for json_key in "${!mapping[@]}"; do
            vite_env_key="${mapping[$json_key]}"
            value=$(echo "$JSON_SECRET_CONTENT" | jq -r --arg key "$json_key" '.[$key]')
            if [[ "$value" == "null" ]]; then
              value=""
            fi
            echo "${vite_env_key}=${value}" >> "$GITHUB_ENV"
          done
        shell: bash

      - run: npm run build
      
      # This action is suitable for deploying to Hosting Preview Channels
      # It does NOT deploy Cloud Functions.
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MULTIPLICATIONMASTER }}
          projectId: multiplicationmaster # Deploy previews to your dev project
