# This file was auto-generated by the Firebase CLI and modified for comprehensive dev deployment

name: Deploy to Firebase Dev on develop branch merge
on:
  push:
    branches:
      - develop
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install React app dependencies
        run: npm install

      - name: Load Dev Environment Variables from JSON Secret
        env:
          JSON_SECRET_CONTENT: ${{ secrets.DEV_ENV_VARS }} # Your secret for dev env vars
        run: |
          declare -A mapping=(
              ["FirebaseAPIKey"]="VITE_FIREBASE_API_KEY"
              ["FirebaseAuthDomain"]="VITE_FIREBASE_AUTH_DOMAIN"
              ["FirebaseProjectID"]="VITE_FIREBASE_PROJECT_ID"
              ["FirebaseMessagingSenderID"]="VITE_FIREBASE_MESSAGING_SENDER_ID"
              ["FirebaseAppId"]="VITE_FIREBASE_APP_ID"
              ["FirebaseStorageBucket"]="VITE_FIREBASE_STORAGE_BUCKET"
              ["FirebaseMeasurementId"]="VITE_FIREBASE_MEASUREMENT_ID"
          )

          for json_key in "${!mapping[@]}"; do
            vite_env_key="${mapping[$json_key]}"
            value=$(echo "$JSON_SECRET_CONTENT" | jq -r --arg key "$json_key" '.[$key]')
            if [[ "$value" == "null" ]]; then
              value=""
            fi
            echo "${vite_env_key}=${value}" >> "$GITHUB_ENV"
          done
        shell: bash

      - name: Build React app for development
        run: npm run build

      - name: Install Cloud Functions dependencies
        run: npm install
        working-directory: functions # Run npm install in the functions directory

      - name: Build Cloud Functions
        run: npm run build
        working-directory: functions # Run npm build in the functions directory

      - name: Deploy Hosting and Functions to Firebase Development Project
        env:
          FIREBASE_SA_KEY_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MULTIPLICATIONMASTER }}
        run: |
          # Pipe the environment variable directly into jq to ensure it's valid JSON
          # and then write it to the service_account_key.json file.
          echo "$FIREBASE_SA_KEY_JSON" | jq -c '.' > service_account_key.json
          
          # Ensure the service account key is removed on exit, even if the deploy fails
          trap "rm -f service_account_key.json" EXIT
          
          # Set the GOOGLE_APPLICATION_CREDENTIALS environment variable
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service_account_key.json"
          
          # Explicitly install firebase-tools to ensure it's available
          npm install -g firebase-tools
          
          # Execute the Firebase deploy command
          firebase deploy --only hosting,functions,firestore,storage --project multiplicationmaster --force
        shell: bash
